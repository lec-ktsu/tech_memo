# BM25Retriever ã®ä½¿ã„æ–¹ ãã® 1
2025.09.14

## BM25ã«ã¤ã„ã¦
BM25ï¼ˆBest Matching 25ï¼‰ã¯ã€æƒ…å ±æ¤œç´¢ï¼ˆIR: Information Retrievalï¼‰ã‚„è‡ªç„¶è¨€èªå‡¦ç†ï¼ˆNLPï¼‰ã§ä½¿ã‚ã‚Œã‚‹ å˜èªã®é‡è¦åº¦ï¼ˆã‚¹ã‚³ã‚¢ï¼‰ã‚’è©•ä¾¡ã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  ã§ã™ã€‚ç‰¹ã«æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§ã‚¯ã‚¨ãƒªï¼ˆæ¤œç´¢èªï¼‰ã¨æ–‡æ›¸ã®é–¢é€£åº¦ã‚’æ¸¬ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã¾ã™ã€‚</br>

### BM25ã¨ã¯ï¼Ÿ

BM25ã¯ã€ç¢ºç‡çš„ãªæƒ…å ±æ¤œç´¢ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹ã€ŒOkapi BM25ã€ã«åŸºã¥ãæ‰‹æ³•ã§ã™ã€‚TF-IDFã®æ”¹è‰¯ç‰ˆã¨è€ƒãˆã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
BM25ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ¡ä»¶ã‚’è€ƒæ…®ã—ã¦ã‚¯ã‚¨ãƒªã¨æ–‡æ›¸ã®é–¢é€£åº¦ã‚’è©•ä¾¡ã—ã¾ã™ï¼š

- å˜èªã®é »åº¦ï¼ˆTFï¼‰ï¼šæ–‡æ›¸ã«ãã®å˜èªãŒã©ã‚Œã ã‘å«ã¾ã‚Œã¦ã„ã‚‹ã‹ã€‚
- é€†æ–‡æ›¸é »åº¦ï¼ˆIDFï¼‰ï¼šãã®å˜èªãŒã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã§ã©ã‚Œã ã‘çã—ã„ã‹ã€‚
- æ–‡æ›¸ã®é•·ã•ã®è£œæ­£ï¼šæ–‡æ›¸ãŒé•·ã™ãã¦ã‚‚ã‚¹ã‚³ã‚¢ãŒä¸å½“ã«é«˜ããªã‚‰ãªã„ã‚ˆã†ã«èª¿æ•´ã€‚

### BM25ã®ã‚¹ã‚³ã‚¢è¨ˆç®—å¼

BM25ã‚¹ã‚³ã‚¢ã¯ã€ã‚¯ã‚¨ãƒªä¸­ã®å„å˜èª `ğ‘` ã«å¯¾ã—ã¦æ¬¡å¼ã§è¨ˆç®—ã•ã‚Œã¾ã™ï¼š
$$
score(Q, D) = \sum_{q \in Q} IDF(q) \cdot \frac{f(q,D)\cdot (k_1 + 1)}{f(q,D)+k_1\cdot (1-b+b\cdot\frac{|D|}{avgdl})}
$$
ã“ã“ã§ã€`$Q$`ã¯æ¤œç´¢ã‚¯ã‚¨ãƒªã€`$D$`ã¯æ–‡æ›¸ã€`$f(q,D)$`ã¯å˜èª$q$ã®æ–‡æ›¸$D$ä¸­ã®å‡ºç¾å›æ•°ã€`$|D|$`ã¯æ–‡æ›¸$D$ã®é•·ã•ã€`$avgdl$`ã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®æ–‡æ›¸ã®å¹³å‡é•·ã€`$k_1$`ã¯TFã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå…¸å‹çš„ã«ã¯ 1.2 ï½ 2.0ï¼‰ã€`$b$`ã¯æ–‡æ›¸é•·ã®æ­£è¦åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆé€šå¸¸ 0.75ï¼‰ã€`$IDF(q)$`ã¯é€†æ–‡æ›¸é »åº¦ï¼ˆå˜èªã®çã—ã•ã‚’è¡¨ã™ï¼‰ã§ã‚ã‚‹ã€‚

### IDF ã®è¨ˆç®—
IDF ã‚‚é€šå¸¸ã® TF-IDF ã¨ã¯é•ã„ã€BM25 ã§ã¯æ¬¡å¼ã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚
$$
IDF(q) = log\left(\frac{N - n(q) + 0.5}{n(q) + 0.5} + 1\right)
$$
ã“ã“ã§ã€$N$ã¯æ–‡æ›¸å…¨ä½“ã®æ•°ã€$n(q)$ã¯å˜èª$q$ã‚’å«ã‚€æ–‡æ›¸ã®æ•°ã‚’è¡¨ã™ã€‚

### BM25 ã®ç‰¹å¾´ã¨åˆ©ç‚¹
| ç‰¹å¾´           | èª¬æ˜                                      |
| ------------ | --------------------------------------- |
| TF-IDFã‚ˆã‚Šé«˜ç²¾åº¦  | é•·ã•è£œæ­£ã‚„é »åº¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒã‚ã‚‹ãŸã‚ã€ã‚ˆã‚Šç¾å®Ÿçš„                |
| é«˜é€Ÿã‹ã¤åŠ¹ç‡çš„      | Luceneï¼ˆElasticsearchï¼‰ãªã©å¤šãã®IRã‚¨ãƒ³ã‚¸ãƒ³ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ |
| ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´å¯ | $k_1$, $b$ ã«ã‚ˆã‚ŠæŸ”è»Ÿãªèª¿æ•´ãŒå¯èƒ½                  |



## å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
`BM25Retriever` ã¯å†…éƒ¨ã§ `rank_bm25` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã‘ã‚Œã°ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
```python
pip install rank_bm25
```

## æ¤œè¨¼ã«ç”¨ã„ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

|ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å|ãƒãƒ¼ã‚¸ãƒ§ãƒ³|
|--|--|
|langchain-core|0.3.75|
|langchain-community|0.3.29|
|langchain|0.3.27|
|python|3.12.9|

`BM25Retriever` ã¯ `langchain_community.retrievers.bm25` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚ã‚‹ã€‚
ã¤ã¾ã‚Šã€æ¬¡ã®ã‚ˆã†ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã€‚
```python
from langchain_community.retrievers import BM25Retriever
from langchain_core.documents import Document
from langchain.text_splitter import CharacterTextSplitter
```

æ¤œç´¢å¯¾è±¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æº–å‚™ã™ã‚‹ã€‚
```python
# ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
docs = [
    Document(page_content="Pythonã¯äººæ°—ã®é«˜ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚", meta_data="ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª", tag="ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª"),
    Document(page_content="æ±äº¬ã¯æ—¥æœ¬ã®é¦–éƒ½ã§ã‚ã‚Šã€çµŒæ¸ˆã®ä¸­å¿ƒåœ°ã§ã™ã€‚", meta_data="æ—¥æœ¬", tag=["æ±äº¬", "çµŒæ¸ˆ", "é¦–éƒ½"]),
    Document(page_content="å¯¿å¸ã¯æ—¥æœ¬ã®ä»£è¡¨çš„ãªæ–™ç†ã®ä¸€ã¤ã§ã™ã€‚", meta_data="æ—¥æœ¬", tag=["å¯¿å¸", "æ–™ç†"]),
    Document(page_content="å¯Œå£«å±±ã¯æ—¥æœ¬ä¸€é«˜ã„å±±ã§ã™ã€‚", meta_data="æ—¥æœ¬", tag=["å¯Œå£«å±±", "å±±"]),
]

# ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†å‰²ï¼ˆBM25ã¯Bag-of-Wordsãªã®ã§ã€é©åˆ‡ã«åˆ†å‰²ã™ã‚‹ã®ãŒè‰¯ã„ï¼‰
text_splitter = CharacterTextSplitter(chunk_size=50, chunk_overlap=0)
split_docs = text_splitter.split_documents(docs)
print(type(split_docs), type(split_docs[0]))
print(split_docs[0])
```

BM25Retrieverã‚’åˆæœŸåŒ–ã™ã‚‹ã€‚
```python
retriever = BM25Retriever.from_documents(split_docs, k=3)
```

æ¤œç´¢å¯¾è±¡ã®æ–‡æ›¸ã«å¯¾ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã™ã‚‹ã€‚
```python
query = "æ—¥æœ¬ã®å±±"
results = retriever.invoke(query, meta_data="æ—¥æœ¬")
```

çµæœã‚’è¡¨ç¤ºã™ã‚‹ã€‚
```python
print(f"ğŸ” ã‚¯ã‚¨ãƒª: {query}")
print("ğŸ“„ æ¤œç´¢çµæœ:")
for i, doc in enumerate(results):
    print(f"{i+1}. {doc.page_content}")
```


æœ€å¾Œã«ã‚³ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦è¨˜è¼‰ã—ã¦ãŠãã€‚
```python
from langchain_community.retrievers import BM25Retriever
from langchain_core.documents import Document
from langchain.text_splitter import CharacterTextSplitter

# 1. ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
docs = [
    Document(page_content="Pythonã¯äººæ°—ã®é«˜ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚", meta_data="ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª", tag="ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª"),
    Document(page_content="æ±äº¬ã¯æ—¥æœ¬ã®é¦–éƒ½ã§ã‚ã‚Šã€çµŒæ¸ˆã®ä¸­å¿ƒåœ°ã§ã™ã€‚", meta_data="æ—¥æœ¬", tag=["æ±äº¬", "çµŒæ¸ˆ", "é¦–éƒ½"]),
    Document(page_content="å¯¿å¸ã¯æ—¥æœ¬ã®ä»£è¡¨çš„ãªæ–™ç†ã®ä¸€ã¤ã§ã™ã€‚", meta_data="æ—¥æœ¬", tag=["å¯¿å¸", "æ–™ç†"]),
    Document(page_content="å¯Œå£«å±±ã¯æ—¥æœ¬ä¸€é«˜ã„å±±ã§ã™ã€‚", meta_data="æ—¥æœ¬", tag=["å¯Œå£«å±±", "å±±"]),
]

# 2. ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†å‰²ï¼ˆBM25ã¯Bag-of-Wordsãªã®ã§ã€é©åˆ‡ã«åˆ†å‰²ã™ã‚‹ã®ãŒè‰¯ã„ï¼‰
text_splitter = CharacterTextSplitter(chunk_size=50, chunk_overlap=0)
split_docs = text_splitter.split_documents(docs)
print(type(split_docs), type(split_docs[0]))
print(split_docs[0])

# 3. BM25Retriever ã®åˆæœŸåŒ–
retriever = BM25Retriever.from_documents(split_docs, k=3)

# 4. æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ä½¿ã£ã¦é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
query = "æ—¥æœ¬ã®å±±"
results = retriever.invoke(query, meta_data="æ—¥æœ¬")

# 5. çµæœã®è¡¨ç¤º
print(f"ğŸ” ã‚¯ã‚¨ãƒª: {query}")
print("ğŸ“„ æ¤œç´¢çµæœ:")
for i, doc in enumerate(results):
    print(f"{i+1}. {doc.page_content}")
```

[ãƒ›ãƒ¼ãƒ ã¸](../index.html)
[BM25retrieverã®ä½¿ã„æ–¹ ãã® 2](./bm25_02.html)